<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - BUFF</title>
    <script>
      (function () {
        try {
          var saved = localStorage.getItem("theme");
          if (saved === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
          }
        } catch (e) {}
      })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Playwrite+IN:wght@100..400&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="apple-touch-icon" href="icon.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#7b451f" />
  </head>
  <body>
    <div class="nav-wrap">
      <nav class="nav" aria-label="Main">
        <div class="menu-item"><a class="nav-btn" href="index.html">Home</a></div>
        <div class="menu-item"><a class="nav-btn" href="gallery.html">Gallery</a></div>
        <div class="menu-item"><a class="nav-btn" href="our-services.html">Services</a></div>
        <div class="nav-sep"></div>
        <button class="nav-btn" id="theme-toggle" aria-pressed="false" aria-label="Toggle color scheme">Light</button>
      </nav>
    </div>

    <main class="container page-top">
      <section class="contact" style="max-width: 920px;">
        <h3>Admin Console</h3>
        <div class="actions" style="justify-content: space-between; width: 100%;">
          <button class="btn" id="google-signin">Sign in with Google</button>
          <button class="btn alt" id="signout" style="display:none;">Sign out</button>
        </div>
        <p id="auth-status" class="services-note">You must sign in to manage the gallery.</p>
      </section>

      <section class="contact" id="editor" style="max-width: 920px; display:none;">
        <h3>New Gallery Item</h3>
        <form class="contact-form" id="new-item-form">
          <input type="hidden" id="editId" value="" />
          <div class="fields">
            <label>Title
              <input id="title" type="text" placeholder="Optional title" />
            </label>
            <label>Order
              <input id="order" type="number" min="0" value="0" />
            </label>
          </div>
          <label>Caption
            <textarea id="caption" rows="3" placeholder="e.g. Deep cleaning and colour restoration..."></textarea>
          </label>
          <div class="fields">
            <label>Before Image
              <input id="beforeFile" type="file" accept="image/*" />
            </label>
            <label>After Image
              <input id="afterFile" type="file" accept="image/*" />
            </label>
          </div>
          <div class="actions">
            <button type="submit" class="btn" id="saveBtn">Save Item</button>
            <button type="button" class="btn alt" id="cancelEdit" style="display:none;">Cancel Edit</button>
          </div>
        </form>
        <div class="contact-form" style="margin-top: 12px;">
          <h3 style="margin: 0 0 6px;">Preview</h3>
          <article class="case-card" id="preview-card">
            <div class="case-images">
              <img id="preview-before" alt="Before preview" />
              <img id="preview-after" alt="After preview" />
            </div>
            <p class="case-caption" id="preview-caption"></p>
          </article>
        </div>
      </section>

      <section class="contact" id="list" style="max-width: 920px; display:none;">
        <h3>Gallery Items</h3>
        <div id="items" class="contact-form"></div>
      </section>
    </main>

    <div class="fab">
      <a href="https://wa.me/6591870187" target="_blank" rel="noopener" aria-label="Chat on WhatsApp">
        <div class="only-icon">
          <svg class="ico" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M19.11 17.14c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.3-.77.97-.94 1.17-.17.2-.35.22-.65.07-.3-.15-1.25-.46-2.39-1.47-.88-.79-1.47-1.77-1.64-2.07-.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.07-.15-.67-1.6-.92-2.2-.24-.57-.48-.5-.67-.5-.17-.01-.37-.02-.57-.02-.2 0-.52.07-.79.37-.27.3-1.04 1.02-1.04 2.49 0 1.47 1.07 2.9 1.22 3.09.15.2 2.1 3.2 5.08 4.48.71.31 1.26.49 1.69.63.71.23 1.36.2 1.87.12.57-.08 1.77-.72 2.02-1.43.25-.71.25-1.32.17-1.44-.07-.12-.27-.2-.57-.35z"/></svg>
        </div>
        <span>WhatsApp</span>
      </a>
    </div>

    <script>
      (function(){
        var toggle = document.getElementById('theme-toggle');
        function isDark(){ return document.documentElement.getAttribute('data-theme') === 'dark'; }
        function updateLabel(){ if (toggle) { toggle.textContent = isDark() ? 'Dark' : 'Light'; toggle.setAttribute('aria-pressed', String(isDark())); } }
        function setMode(dark){ if(dark){ document.documentElement.setAttribute('data-theme','dark'); try{ localStorage.setItem('theme','dark'); }catch(e){} } else { document.documentElement.removeAttribute('data-theme'); try{ localStorage.removeItem('theme'); }catch(e){} } updateLabel(); }
        updateLabel();
        if (toggle) toggle.addEventListener('click', function(){ setMode(!isDark()); });
      })();
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import { initializeFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCH1gJdghp8-9F_-Nu6CeFUdLt7Phz5XKQ",
        authDomain: "buffworks-ba25a.firebaseapp.com",
        projectId: "buffworks-ba25a",
        storageBucket: "buffworks-ba25a.appspot.com",
        messagingSenderId: "30729552717",
        appId: "1:30729552717:web:5d4d280877c44ac6102d04",
        measurementId: "G-0WMFLVR59M"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });

      const signinBtn = document.getElementById('google-signin');
      const signoutBtn = document.getElementById('signout');
      const editor = document.getElementById('editor');
      const listSection = document.getElementById('list');
      const authStatus = document.getElementById('auth-status');
      const provider = new GoogleAuthProvider();

      function setAuthed(authed, user){
        signinBtn.style.display = authed ? 'none' : '';
        signoutBtn.style.display = authed ? '' : 'none';
        editor.style.display = authed ? '' : 'none';
        listSection.style.display = authed ? '' : 'none';
        authStatus.textContent = authed ? `Signed in as ${user?.email || ''}` : 'You must sign in to manage the gallery.';
      }

      // Basic offline/online UX guard
      function setOnlineState(){
        const online = navigator.onLine;
        const form = document.getElementById('new-item-form');
        if (form) {
          Array.from(form.querySelectorAll('button, input, textarea')).forEach(function(el){ el.disabled = !online; });
        }
        if (!online) authStatus.textContent = 'You appear to be offline. Changes will fail until you reconnect.';
      }
      window.addEventListener('online', setOnlineState);
      window.addEventListener('offline', setOnlineState);
      setOnlineState();

      onAuthStateChanged(auth, (user)=>{ setAuthed(!!user, user); if (user) loadItems(); });
      signinBtn.addEventListener('click', async ()=>{ await signInWithPopup(auth, provider); });
      signoutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

      function fileToDataUrl(file){
        return new Promise(function(resolve, reject){
          if (!file) return resolve(null);
          var reader = new FileReader();
          reader.onload = function(){ resolve(reader.result); };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function imageToJpegDataUrl(file, maxSide){
        if (!file) return null;
        const dataUrl = await fileToDataUrl(file);
        try {
          const img = new Image();
          img.decoding = 'async';
          await new Promise(function(res, rej){ img.onload = res; img.onerror = rej; img.src = dataUrl; });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const w = img.width, h = img.height;
          const scale = Math.min(1, (maxSide || 1600) / Math.max(w, h));
          canvas.width = Math.round(w * scale);
          canvas.height = Math.round(h * scale);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          // Convert to JPEG to keep under Firestore 1MB doc limit
          return canvas.toDataURL('image/jpeg', 0.82);
        } catch (e) {
          // Fall back to original data URL if canvas fails
          return dataUrl;
        }
      }

      async function loadItems(){
        const itemsEl = document.getElementById('items');
        itemsEl.innerHTML = '';
        const qy = query(collection(db, 'gallery'), orderBy('order','asc'));
        const snap = await getDocs(qy);
        snap.forEach(function(docSnap){
          const d = docSnap.data();
          const wrap = document.createElement('div');
          wrap.className = 'contact-form';
          const card = document.createElement('article');
          card.className = 'case-card';
          const imgs = document.createElement('div');
          imgs.className = 'case-images';
          const b = document.createElement('img');
          b.src = d.beforeData || d.beforeUrl || '';
          const a = document.createElement('img');
          a.src = d.afterData || d.afterUrl || '';
          imgs.appendChild(b); imgs.appendChild(a);
          const cap = document.createElement('p');
          cap.className = 'case-caption';
          cap.textContent = d.caption || '';
          card.appendChild(imgs); card.appendChild(cap);
          const actions = document.createElement('div');
          actions.className = 'actions';
          const editBtn = document.createElement('button'); editBtn.className='btn alt'; editBtn.textContent='Edit';
          const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Delete';
          actions.appendChild(editBtn); actions.appendChild(delBtn);
          wrap.appendChild(card); wrap.appendChild(actions);
          itemsEl.appendChild(wrap);

          editBtn.addEventListener('click', function(){
            currentEditId = docSnap.id;
            currentEditData = d;
            document.getElementById('editId').value = currentEditId;
            document.getElementById('title').value = d.title || '';
            document.getElementById('caption').value = d.caption || '';
            document.getElementById('order').value = d.order ?? 0;
            document.getElementById('beforeFile').value = '';
            document.getElementById('afterFile').value = '';
            document.getElementById('saveBtn').textContent = 'Update Item';
            document.getElementById('cancelEdit').style.display = '';
            updatePreviewWithData(d);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });

          delBtn.addEventListener('click', async function(){
            if (!confirm('Delete this item?')) return;
            await deleteDoc(doc(db,'gallery', docSnap.id));
            await loadItems();
          });
        });
      }

      document.getElementById('new-item-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const title = document.getElementById('title').value.trim();
        const caption = document.getElementById('caption').value.trim();
        const order = Number(document.getElementById('order').value || 0);
        const beforeFile = document.getElementById('beforeFile').files[0];
        const afterFile = document.getElementById('afterFile').files[0];

        try {
          if (!auth.currentUser) {
            alert('Please sign in first.');
            return;
          }

          const [beforeData, afterData] = await Promise.all([
            imageToJpegDataUrl(beforeFile, 1600),
            imageToJpegDataUrl(afterFile, 1600)
          ]);

          // Rough guard against 1MB Firestore doc limit
          var approxSize = (JSON.stringify({title, caption, beforeData, afterData}).length || 0);
          if (approxSize > 950000) {
            alert('Images are too large for Firestore. Please select smaller images.');
            return;
          }

          await addDoc(collection(db,'gallery'), {
            title: title || null,
            caption: caption || null,
            order: isNaN(order) ? 0 : order,
            beforeData: beforeData || null,
            afterData: afterData || null,
            createdAt: serverTimestamp()
          });

          e.target.reset();
          await loadItems();
          alert('Saved');
        } catch (err) {
          console.error('Save failed:', err);
          alert('Save failed. Check your connection and permissions.');
        }
      });

      document.getElementById('cancelEdit').addEventListener('click', function(){
        (document.getElementById('new-item-form')).reset();
        currentEditId = null; currentEditData = null;
        document.getElementById('saveBtn').textContent = 'Save Item';
        document.getElementById('cancelEdit').style.display = 'none';
        updatePreviewWithData({});
      });

      function updatePreviewWithData(d){
        const before = document.getElementById('preview-before');
        const after = document.getElementById('preview-after');
        const cap = document.getElementById('preview-caption');
        before.src = d.beforeData || '';
        after.src = d.afterData || '';
        cap.textContent = d.caption || '';
      }

      async function updatePreviewFromInputs(){
        const title = document.getElementById('title').value.trim();
        const caption = document.getElementById('caption').value.trim();
        const beforeFile = document.getElementById('beforeFile').files[0];
        const afterFile = document.getElementById('afterFile').files[0];
        const [b, a] = await Promise.all([fileToDataUrl(beforeFile), fileToDataUrl(afterFile)]);
        updatePreviewWithData({ title, caption, beforeData: b, afterData: a });
      }

      ['title','caption'].forEach(function(id){
        document.getElementById(id).addEventListener('input', function(){ updatePreviewFromInputs(); });
      });
      ['beforeFile','afterFile'].forEach(function(id){
        document.getElementById(id).addEventListener('change', function(){ updatePreviewFromInputs(); });
      });
    </script>
  </body>
  </html>


